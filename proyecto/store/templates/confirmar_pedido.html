{% extends "base.html" %}
{% load static %}
{% block title %}Confirmación de pedido - MiTienda{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/pedido.css' %}">
{% endblock %}

{% block content %}

<div class="container py-4">

    <h2 class="mb-4">Confirmación de Pedido</h2>

    <!-- LISTADO DEL CARRITO -->
    <div class="card mb-4">
        <div class="card-header fw-bold">
            Productos del Pedido
        </div>
        <div class="card-body" id="lista-productos">
            Cargando productos...
        </div>
    </div>

    <!-- FORMULARIO DEL PEDIDO -->
    <div class="card">
        <div class="card-header fw-bold">
            Datos del Pedido
        </div>
        <div class="card-body">

            <form id="form-pedido" >
                
                <div class="mb-3">
                    <label class="form-label">Dirección de Envío</label>
                    <input type="text" class="form-control" id="direccion_envio" required>
                </div>

                <div class="mb-3">
                    <label class="form-label">Teléfono</label>
                    <input type="text" class="form-control" id="telefono" required>
                </div>

                <div class="mb-3">
                    <label class="form-label">Método de Pago</label>
                    <select class="form-select" id="metodo_pago" required>
                        <option value="">Seleccione...</option>
                        <option value="Tarjeta">Tarjeta de Crédito/Débito</option>
                        <option value="PayPal">PayPal</option>
                        <option value="Transferencia">Transferencia Bancaria</option>
                        <option value="Efectivo">Efectivo (Contra Entrega)</option>
                    </select>
                </div>

                <button class="btn btn-primary w-100 mt-3" type="submit">Confirmar Pedido</button>
            
            </form>

        </div>
    </div>
    <script>
        // ----------------- HELPERS -----------------
        const obtenerCarrito = () => JSON.parse(localStorage.getItem('carrito')) || [];
        const guardarCarrito = (carrito) => localStorage.setItem('carrito', JSON.stringify(carrito));
        const vaciarCarrito = () => localStorage.removeItem('carrito');

        // ----------------- PINTAR LISTA -----------------
        const renderCarrito = () => {
            const productos = obtenerCarrito();
            const lista = document.getElementById('lista-productos');
            
            if (productos.length === 0) {
                lista.innerHTML = '<p class="text-muted text-center">No hay productos en tu pedido.</p>';
                return;
            }

            let total = 0;
            lista.innerHTML = productos.map((p, index) => {
                const subtotal = p.precio * p.cantidad;
                total += subtotal;
                return `
                    <div class="producto-item d-flex justify-content-between align-items-center">
                        <div class="mini-info">
                            <strong>${p.nombre}</strong>
                            <small>Color: ${p.color}, Talla: ${p.talla}</small>
                            <small>${p.cantidad} x ${p.precio} €</small>
                        </div>
                        <div>
                            <strong class="me-3">${subtotal.toFixed(2)} €</strong>
                            <button class="btn btn-sm btn-outline-danger btn-eliminar-pedido" data-index="${index}">×</button>
                        </div>
                    </div>
                `;
            }).join('');

            lista.innerHTML += `
                <div class="producto-item d-flex justify-content-between align-items-center fw-bold fs-5">
                    <span>Total</span>
                    <span>${total.toFixed(2)} €</span>
                </div>
            `;
        };

        // ----------------- FUNCIONES DE MANIPULACIÓN -----------------
        const eliminarProducto = (producto) => {
            let carrito = obtenerCarrito();
            // Usamos un identificador único para cada variante en el carrito
            const idUnico = producto.id + '-' + producto.color + '-' + producto.talla;
            carrito = carrito.filter(p => (p.id + '-' + p.color + '-' + p.talla) !== idUnico);
            guardarCarrito(carrito);
            renderCarrito(); // Volver a pintar la lista
        };

        // ----------------- CONTROLES -----------------
        document.addEventListener('click', (e) => {
    if (e.target.matches('.btn-sumar-pedido')) {
        const index = e.target.dataset.index;
        const productos = obtenerCarrito();
        incrementar(productos[index]);
    }

    if (e.target.matches('.btn-restar-pedido')) {
        const index = e.target.dataset.index;
        const productos = obtenerCarrito();
        decrementar(productos[index]);
    }

    if (e.target.matches('.btn-eliminar-pedido')) {
        const index = e.target.dataset.index;
        const productos = obtenerCarrito();
        eliminarProducto(productos[index]);

    }
});
        
        // ----------------- CARGAR AL ABRIR -----------------
        window.onload = () => {
            renderCarrito();
            
        };
        
        // ----------------- ENVIAR PEDIDO -----------------
        document.getElementById("form-pedido").addEventListener("submit", (e) => {
            e.preventDefault(); // Evitamos que el formulario se envíe de la forma tradicional
        
            const pedido = {
                direccion_envio: document.getElementById("direccion_envio").value,
                telefono: document.getElementById("telefono").value,
                metodo_pago: document.getElementById("metodo_pago").value,
                productos: obtenerCarrito() // Obtenemos los productos del localStorage
            };
        
            // Enviamos los datos al backend
            fetch("{% url 'confirmar_pedido' %}", {
                method: "POST",
                headers: {
                    'Content-Type': 'application/json',
                    // Si no usas @csrf_exempt, necesitarías enviar el token CSRF aquí
                },
                body: JSON.stringify(pedido)
            })
            .then(response => response.json())
            .then(data => {
                if (data.error) {
                    alert("Error al crear el pedido: " + data.error);
                } else {
                    alert("¡Pedido realizado con éxito! ID del pedido: " + data.pedido_id);
                    vaciarCarrito(); // Limpiamos el carrito del localStorage
                    window.location.href = "/"; // Redirigimos al inicio
                }
            })
            .catch(error => {
                console.error("Error en la petición:", error);
                alert("Ha ocurrido un error inesperado. Por favor, inténtalo de nuevo.");
            });
        
        });
        </script>
        
</div>
{% endblock %}
