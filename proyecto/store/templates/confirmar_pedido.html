{% extends "base.html" %}
{% load static %}
{% block title %}Confirmación de pedido - MiTienda{% endblock %}

{% block extra_css %}
    <link rel="stylesheet" href="{% static 'css/pedido.css' %}">
{% endblock %}

{% block content %}

<div class="container py-4">

    <h2 class="mb-4">Confirmación de Pedido</h2>

    <!-- LISTADO DEL CARRITO -->
    <div class="card mb-4">
        <div class="card-header fw-bold">
            Productos del Pedido
        </div>
        <div class="card-body" id="lista-productos">
            Cargando productos...
        </div>
    </div>

    <!-- RESUMEN DEL PEDIDO -->
    <div class="card mb-4">
        <div class="card-header fw-bold">
            Resumen del Pedido
        </div>
        <div class="card-body">
            <div class="row">
                <div class="col-6"><strong>Subtotal:</strong></div>
                <div class="col-6 text-end" id="res_subtotal">0.00 €</div>
            </div>
            <div class="row mt-2">
                <div class="col-6"><strong>Descuento:</strong></div>
                <div class="col-6 text-end text-danger" id="res_descuento">0.00 €</div>
            </div>
            <div class="row mt-2">
                <div class="col-6"><strong>Precio con descuento:</strong></div>
                <div class="col-6 text-end" id="res_precio_con_descuento">0.00 €</div>
            </div>
            <div class="row mt-2">
                <div class="col-6"><strong>Coste envío:</strong></div>
                <div class="col-6 text-end" id="res_coste_envio">0.00 €</div>
            </div>
            <div class="row mt-2">
                <div class="col-6"><strong>Impuestos (21%):</strong></div>
                <div class="col-6 text-end" id="res_impuestos">0.00 €</div>
            </div>
            <hr>
            <div class="row mt-2 fw-bold fs-5">
                <div class="col-6">TOTAL</div>
                <div class="col-6 text-end" id="res_total">0.00 €</div>
            </div>
        </div>
    </div>

    <!-- FORMULARIO DEL PEDIDO -->
    <div class="card">
        <div class="card-header fw-bold">
            Datos del Pedido
        </div>
        <div class="card-body">

            <form id="form-pedido" >
                {% csrf_token %}
                {% if not user.is_authenticated %}
                 <div class="mb-3">
                    <label class="form-label">Nombre</label>
                    <input type="text" class="form-control" id="nombre" name="nombre" required>
                  </div>

                <div class="mb-3">
                    <label class="form-label">Email</label>
                    <input type="email" class="form-control" id="email" name="email" required>
                </div>
                {% endif %}
                <div class="mb-3">
                    <label class="form-label">Dirección de Envío</label>
                    <input type="text" class="form-control" id="direccion_envio" required>
                </div>

                <div class="mb-3">
                    <label class="form-label">Teléfono</label>
                    <input type="text" class="form-control" id="telefono" required>
                </div>
                
                <div class="mb-3">
                    <label class="form-label">Método de Pago</label>
                    <p class="form-control-plaintext"><strong>Tarjeta de Crédito/Débito</strong></p>
                </div>

                <div id="stripe-element-wrapper" class="mb-3 border rounded p-3" style="display:none;background:#f8f9fa;">
                    <h6 class="mb-2">Pagar con Stripe</h6>
                    <div id="payment-element"></div>
                    <div id="payment-message" class="text-danger mt-2" role="alert"></div>
                    <small class="text-muted d-block">Los datos de la tarjeta se tokenizan directamente en Stripe. Nosotros no almacenamos la tarjeta.</small>
                </div>
                <p>Si no recibe correo de confirmación revise la sección de spam</p>
                <button id="btn-confirmar" class="btn btn-primary w-100 mt-3" type="submit">Confirmar Pedido</button>
            
            </form>

        </div>
    </div>
    
        
</div>
{% endblock %}

{% block scripts %}
<script src="https://js.stripe.com/v3/"></script>
<script>
document.addEventListener('DOMContentLoaded', () => {
    const lista = document.getElementById('lista-productos');
    const elSubtotal = document.getElementById('res_subtotal');
    const elDescuento = document.getElementById('res_descuento');
    const elPrecioConDesc = document.getElementById('res_precio_con_descuento');
    const elCosteEnvio = document.getElementById('res_coste_envio');
    const elImpuestos = document.getElementById('res_impuestos');
    const elTotal = document.getElementById('res_total');
    const stripeWrapper = document.getElementById('stripe-element-wrapper');
    const paymentMessageEl = document.getElementById('payment-message');
    const btnConfirmar = document.getElementById('btn-confirmar');
    const formPedido = document.getElementById('form-pedido');
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]')?.value || '';
    const stripePublicKey = "{{ stripe_publishable_key|default:'' }}";
    const stripeInstance = stripePublicKey ? Stripe(stripePublicKey) : null;

    let stripeElements = null;
    let stripePaymentElement = null;
    let stripeClientSecret = null;
    let ultimoResumenCliente = {
        subtotal: 0,
        descuento: 0,
        coste_envio: 0,
        impuestos: 0,
        total: 0
    };

    const invalidarStripeIntent = () => {
        if (stripePaymentElement) {
            stripePaymentElement.unmount();
            stripePaymentElement = null;
        }
        stripeElements = null;
        stripeClientSecret = null;
        if (paymentMessageEl) {
            paymentMessageEl.textContent = '';
        }
    };

    const renderCarrito = () => {
        const productos = obtenerCarrito();
        if (!productos.length) {
            lista.innerHTML = '<p class="text-muted text-center m-0">No hay productos en tu pedido.</p>';
            elSubtotal.innerText = '0.00 €';
            elDescuento.innerText = '0.00 €';
            elPrecioConDesc.innerText = '0.00 €';
            elCosteEnvio.innerText = '0.00 €';
            elImpuestos.innerText = '0.00 €';
            elTotal.innerText = '0.00 €';
            ultimoResumenCliente = {
                subtotal: 0,
                descuento: 0,
                coste_envio: 0,
                impuestos: 0,
                total: 0
            };
            invalidarStripeIntent();
            return;
        }

        invalidarStripeIntent();

        let subtotalOriginal = 0;
        let subtotalConOferta = 0;

        lista.innerHTML = productos.map((p, index) => {
            const precioOriginal = Number(p.precio || 0);
            const precioOferta = p.precio_oferta ? Number(p.precio_oferta) : precioOriginal;
            const cantidad = Number(p.cantidad || 1);

            subtotalOriginal += precioOriginal * cantidad;
            subtotalConOferta += precioOferta * cantidad;

            const ahorroUnit = Math.max(0, precioOriginal - precioOferta);
            const ahorroTotal = ahorroUnit * cantidad;
            const subtotalItem = (precioOferta * cantidad).toFixed(2);
            const precioShow = p.precio_oferta
                ? `<span class="text-danger">${precioOferta.toFixed(2)} €</span> <small class="text-muted text-decoration-line-through">${precioOriginal.toFixed(2)} €</small>`
                : `${precioOriginal.toFixed(2)} €`;

            return `
                <div class="producto-item d-flex justify-content-between align-items-center">
                    <div class="mini-info">
                        <strong>${p.nombre}</strong>
                        <small>Color: ${p.color || '-'}, Talla: ${p.talla || '-'}</small>
                        <small>${cantidad} x ${precioShow}</small>
                        <div class="small text-muted">Precio original: ${precioOriginal.toFixed(2)} € · Precio con oferta: ${precioOferta.toFixed(2)} €</div>
                        ${ahorroTotal > 0 ? `<div class="text-success small">Descuento por unidad: ${ahorroUnit.toFixed(2)} € · Ahorro total: ${ahorroTotal.toFixed(2)} €</div>` : ''}
                    </div>
                    <div>
                        <strong class="me-3">${subtotalItem} €</strong>
                        <button class="btn btn-sm btn-outline-danger btn-eliminar-pedido" data-index="${index}">×</button>
                    </div>
                </div>
            `;
        }).join('');

        const descuentoTotal = Math.max(0, subtotalOriginal - subtotalConOferta);
        const precioConDescuento = subtotalConOferta;
        const costeEnvio = precioConDescuento >= 50 ? 0 : 4.99;
        const impuestos = +(precioConDescuento * 0.21).toFixed(2);
        const total = +(precioConDescuento + costeEnvio + impuestos).toFixed(2);

        elSubtotal.innerText = subtotalOriginal.toFixed(2) + ' €';
        elDescuento.innerText = descuentoTotal.toFixed(2) + ' €';
        elPrecioConDesc.innerText = precioConDescuento.toFixed(2) + ' €';
        elCosteEnvio.innerText = costeEnvio.toFixed(2) + ' €';
        elImpuestos.innerText = impuestos.toFixed(2) + ' €';
        elTotal.innerText = total.toFixed(2) + ' €';

        lista.innerHTML += `
            <div class="producto-item d-flex justify-content-between align-items-center fw-bold fs-5 mt-3">
                <span>Total (pre-IVA y envío):</span>
                <span>${precioConDescuento.toFixed(2)} €</span>
            </div>
        `;

        ultimoResumenCliente = {
            subtotal: Number(precioConDescuento.toFixed(2)),
            descuento: Number(descuentoTotal.toFixed(2)),
            coste_envio: Number(costeEnvio.toFixed(2)),
            impuestos: Number(impuestos.toFixed(2)),
            total: Number(total.toFixed(2))
        };
    };

    document.addEventListener('click', (event) => {
        if (event.target.matches('.btn-sumar-pedido')) {
            const index = event.target.dataset.index;
            const productos = obtenerCarrito();
            incrementar(productos[index]);
            renderCarrito();
        }

        if (event.target.matches('.btn-restar-pedido')) {
            const index = event.target.dataset.index;
            const productos = obtenerCarrito();
            decrementar(productos[index]);
            renderCarrito();
        }

        if (event.target.matches('.btn-eliminar-pedido')) {
            const index = event.target.dataset.index;
            const productos = obtenerCarrito();
            eliminarProducto(productos[index]);
            renderCarrito();
        }
    });

    const toggleCamposPago = () => {
        stripeWrapper.style.display = 'block';
        prepararStripePago();
    };

    const prepararStripePago = async () => {
        if (!stripeInstance) {
            if (paymentMessageEl) paymentMessageEl.textContent = 'Stripe no está configurado.';
            return;
        }

        if (!obtenerCarrito().length) {
            if (paymentMessageEl) paymentMessageEl.textContent = 'Añade productos al carrito antes de pagar.';
            return;
        }

        if (stripeClientSecret) {
            return;
        }

        btnConfirmar.disabled = true;
        try {
            const response = await fetch("{% url 'crear_payment_intent' %}", {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-CSRFToken': csrfToken
                },
                body: JSON.stringify({
                    productos: obtenerCarrito(),
                    coste_envio: ultimoResumenCliente.coste_envio
                })
            });

            const data = await response.json();
            if (!response.ok || data.error) {
                throw new Error(data.error || 'No se pudo preparar el pago.');
            }

            stripeClientSecret = data.client_secret;
            if (stripePaymentElement) {
                stripePaymentElement.unmount();
            }

            stripeElements = stripeInstance.elements({ clientSecret: stripeClientSecret });
            stripePaymentElement = stripeElements.create('payment');
            stripePaymentElement.mount('#payment-element');

            if (paymentMessageEl) paymentMessageEl.textContent = '';
        } catch (error) {
            if (paymentMessageEl) paymentMessageEl.textContent = error.message;
            stripeClientSecret = null;
        } finally {
            btnConfirmar.disabled = false;
        }
    };

    const actualizarResumenDesdeServidor = (resumen) => {
        if (!resumen) return;
        elSubtotal.innerText = Number(resumen.subtotal).toFixed(2) + ' €';
        elDescuento.innerText = Number(resumen.descuento).toFixed(2) + ' €';
        elPrecioConDesc.innerText = (Number(resumen.subtotal) - Number(resumen.descuento)).toFixed(2) + ' €';
        elCosteEnvio.innerText = Number(resumen.coste_envio).toFixed(2) + ' €';
        elImpuestos.innerText = Number(resumen.impuestos).toFixed(2) + ' €';
        elTotal.innerText = Number(resumen.total).toFixed(2) + ' €';
    };

    const enviarPedido = async (extra = {}) => {
        const productos = obtenerCarrito();
        const metodo = 'Tarjeta'; // Método de pago fijo
        const direccion = document.getElementById('direccion_envio').value.trim();
        const telefono = document.getElementById('telefono').value.trim();

        if (!direccion || !telefono) {
            alert('Completa la dirección y el teléfono.');
            return;
        }

        if (!productos.length) {
            alert('Tu carrito está vacío.');
            return;
        }

        const payload = {
            direccion_envio: direccion,
            telefono,
            metodo_pago: metodo,
            productos,
            coste_envio: ultimoResumenCliente.coste_envio,
            ...extra
        };
        {% if not user.is_authenticated %}
    const nombre = document.getElementById('nombre').value.trim();
    const email = document.getElementById('email').value.trim();

    if (!nombre || !email) {
        alert('Debes completar nombre y email.');
        return;
    }

    payload.nombre = nombre;
    payload.email = email;
    {% endif %}
        if (metodo === 'PayPal') {
            const paypalEmail = document.getElementById('paypal_email').value.trim();
            if (!paypalEmail) {
                alert('Introduce el email de PayPal.');
                return;
            }
            payload.paypal_email = paypalEmail;
        }

        const response = await fetch("{% url 'confirmar_pedido' %}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify(payload)
        });

        const data = await response.json();
        if (!response.ok || data.error) {
            throw new Error(data.error || 'No se pudo crear el pedido.');
        }

        if (data.resumen) {
            actualizarResumenDesdeServidor(data.resumen);
            const items = data.items || [];
            let mensaje = `Pedido creado (ID ${data.pedido_id})\\n\\nResumen:\\n`;
            mensaje += `Subtotal: ${Number(data.resumen.subtotal).toFixed(2)} €\\n`;
            mensaje += `Descuento: ${Number(data.resumen.descuento).toFixed(2)} €\\n`;
            mensaje += `Coste envío: ${Number(data.resumen.coste_envio).toFixed(2)} €\\n`;
            mensaje += `Impuestos: ${Number(data.resumen.impuestos).toFixed(2)} €\\n`;
            mensaje += `TOTAL a pagar: ${Number(data.resumen.total).toFixed(2)} €\\n\\n`;
            mensaje += 'Detalle de productos:\\n';
            items.forEach(it => {
                mensaje += `- ${it.nombre} (${it.color||'-'}, ${it.talla||'-'}) x${it.cantidad}: ${parseFloat(it.subtotal_item).toFixed(2)} €`;
                if (it.descuento_item && Number(it.descuento_item) > 0) {
                    mensaje += ` (Descuento: ${parseFloat(it.descuento_item).toFixed(2)} €)`;
                }
                mensaje += '\\n';
            });
            alert(mensaje);
        } else {
            alert(`¡Pedido realizado con éxito! ID del pedido: ${data.pedido_id}`);
        }

        vaciarCarrito();
        window.location.href = '/';
    };

    formPedido.addEventListener('submit', async (event) => {
        event.preventDefault();
        if (!stripeInstance) {
            alert('Stripe no está disponible en este momento.');
            return;
        }
        await prepararStripePago();
        if (!stripeClientSecret || !stripeElements) {
            return;
        }

        btnConfirmar.disabled = true;
        try {
            const { error, paymentIntent } = await stripeInstance.confirmPayment({
                elements: stripeElements,
                confirmParams: {
                    return_url: window.location.href
                },
                redirect: 'if_required'
            });

            if (error) {
                if (paymentMessageEl) paymentMessageEl.textContent = error.message;
                return;
            }

            if (!paymentIntent || paymentIntent.status !== 'succeeded') {
                if (paymentMessageEl) paymentMessageEl.textContent = 'No se pudo completar el pago.';
                return;
            }

            await enviarPedido({ payment_intent_id: paymentIntent.id });
        } catch (err) {
            alert(err.message || 'No se pudo confirmar el pago.');
        } finally {
            btnConfirmar.disabled = false;
        }
    });

    renderCarrito();
    toggleCamposPago();
});
</script>
{% endblock %}
